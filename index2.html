<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#2c3e50" />

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFMSASO(OS201) - Tra√ßabilit√© en St√©rilisation</title>
    <style>
      #loading-indicator {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 1.5rem;
  font-weight: bold;
  color: #3498db;
  display: none;
}

#loading-indicator.hidden {
  display: none !important;
}

      .stats-box {
  margin-bottom: 20px;
  padding: 12px;
  border-radius: 8px;
  background-color: #ecf0f1;
}
.stats-box p {
  font-weight: bold;
  margin: 6px 0;
  color: #2c3e50;
}

/* üåô Mode sombre */
body.dark-mode .stats-box {
  background-color: #1e1e1e;
}
body.dark-mode .stats-box p {
  color: #f5f5f5;
}

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .app-container {
    max-width: 1200px;
    width: 90%;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
}

        .app-header {
            background-color: #2c3e50;
            color: white;
            padding: 16px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .app-title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 500;
        }
        .app-subtitle {
            margin: 5px 0 0;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .app-content {
            padding: 16px;
        }
        .form-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .code-number {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        .form-date {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .form-date label {
            font-weight: 500;
        }
        .form-date input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .section {
            background-color: white;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .section-header {
            background-color: #3498db;
            color: white;
            padding: 12px 16px;
            font-size: 1.1rem;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .section-content {
            padding: 16px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #2c3e50;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        .radio-group, .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
        }
        .radio-option, .checkbox-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1rem;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #2c3e50;
            color: white;
        }
        .btn-primary:hover {
            background-color: #1a252f;
        }
        .btn-submit {
            background-color: #27ae60;
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            margin-top: 20px;
        }
        .btn-submit:hover {
            background-color: #219653;
        }
        .tabs {
            display: flex;
            background-color: #f5f5f5;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            background-color: #f5f5f5;
            transition: background-color 0.2s;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
            font-weight: 500;
        }
        .warning-banner {
            background-color: #f39c12;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: 500;
            text-align: center;
        }
        .signature-area {
            border: 1px dashed #ddd;
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 5px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        .step {
            text-align: center;
            flex: 1;
            position: relative;
        }
        .step:not(:last-child):after {
            content: "";
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background-color: #e0e0e0;
            z-index: 1;
        }
        .step-number {
            width: 30px;
            height: 30px;
            background-color: #e0e0e0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 5px;
            font-weight: bold;
            color: #7f8c8d;
            position: relative;
            z-index: 2;
        }
        .step.active .step-number {
            background-color: #3498db;
            color: white;
        }
        .step.completed .step-number {
            background-color: #27ae60;
            color: white;
        }
        .step-label {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
        .step.active .step-label {
            color: #3498db;
            font-weight: 500;
        }
        .step.completed .step-label {
            color: #27ae60;
            font-weight: 500;
        }
        .form-section {
    display: none;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.4s ease;
}

.form-section.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
}

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .nav-button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        .prev-button {
            background-color: #e0e0e0;
            color: #333;
        }
        .next-button {
            background-color: #3498db;
            color: white;
        }
        /* Styles pour la page d'accueil */
        .welcome-page {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
            text-align: center;
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
        }
        .logo-container {
            margin-bottom: 40px;
        }
        .logo {
            width: 150px;
            height: 150px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto;
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .welcome-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .welcome-subtitle {
            font-size: 1.2rem;
            margin-bottom: 40px;
            opacity: 0.9;
        }
        .login-form {
            width: 100%;
            max-width: 320px;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        .login-form .form-group {
            margin-bottom: 20px;
        }
        .login-form label {
            color: #2c3e50;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .login-form .form-control {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
        }
        .login-btn {
            background-color: #27ae60;
            color: white;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .login-btn:hover {
            background-color: #219653;
        }
        .version-info {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0.8;
    font-size: 0.85rem;
    color: white;
    z-index: 1000;
    background-color: rgba(0, 0, 0, 0.3);
    padding: 4px 12px;
    border-radius: 6px;
}

        /* Pour passer de la page d'accueil √† l'application */
        
        @media (min-width: 768px) {
    .form-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .form-group label {
        flex: 1;
        margin-right: 10px;
    }

    .form-control {
        flex: 2;
    }

    .checkbox-group, .radio-group {
        justify-content: start;
    }

    .navigation-buttons {
        justify-content: flex-end;
    }
}
.hidden {
    display: none !important;
}@media (max-width: 600px) {
  .form-group {
    flex-direction: column !important;
    align-items: stretch !important;
  }

  .form-group label {
    margin-bottom: 5px;
  }

  .radio-group, .checkbox-group {
    flex-direction: column !important;
    gap: 5px;
  }

  .login-form, .form-section, .section {
    padding: 15px !important;
  }

  .navigation-buttons {
    flex-direction: column;
    gap: 10px;
  }

  .btn, .btn-submit {
    width: 100% !important;
  }

  .step-indicator {
    flex-direction: column;
    gap: 10px;
  }

  .step:after {
    display: none !important;
  }

  .step-number {
    margin-bottom: 5px;
  }

  #dashboard-list > div {
    font-size: 0.9rem;
  }

  .app-header {
    text-align: center;
  }

  .welcome-title {
    font-size: 2rem;
  }

  .welcome-subtitle {
    font-size: 1rem;
  }

  .section-header {
    font-size: 1rem;
    flex-direction: column;
    align-items: flex-start;
    gap: 5px;
  }

  .signature-area {
    flex-direction: column;
    height: auto;
  }
}

/* üåô Dark Mode Styles */
body.dark-mode {
  background-color: #121212;
  color: #f5f5f5;
}
body.dark-mode label {
  color: #f5f5f5 !important;
}
/* üåô ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑŸÜÿµŸàÿµ ŸÅŸä ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä */
body.dark-mode label,
body.dark-mode strong,
body.dark-mode p,
body.dark-mode .section-content,
body.dark-mode .form-title,
body.dark-mode .code-number,
body.dark-mode select.form-control option {
  color: #f5f5f5 !important;
}

/* ÿÆŸÑŸÅŸäÿ© ÿÆŸÅŸäŸÅÿ© ÿØÿßÿÆŸÑ ÿßŸÑŸÅŸäÿ¥ÿ© */
body.dark-mode .section-content {
  background-color: #1a1a1a;
}

/* ŸÜÿµ ÿßŸÑÿ™Ÿàÿ≥ÿ™ toast ŸÅŸä ÿ≠ÿßŸÑ ÿßÿ≥ÿ™ÿπŸÖŸÑÿ™ ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä */
body.dark-mode #toast {
  background-color: #27ae60;
  color: white;
}

/* ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿ®ÿØÿßÿÆŸÑ ÿßŸÑŸÅŸäÿ¥ÿ© */
body.dark-mode .btn-submit {
  background-color: #2ecc71;
}

body.dark-mode .btn-submit:hover {
  background-color: #27ae60;
}

/* ÿ™ÿ∫ŸäŸäÿ± ÿÆŸÑŸÅŸäÿ© ÿßŸÑŸÄ select ÿπŸÜÿØ ŸÅÿ™ÿ≠ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© */
body.dark-mode select.form-control {
  background-color: #2c2c2c;
}



body.dark-mode .section,
body.dark-mode .login-form,
body.dark-mode .form-control,
body.dark-mode .form-section,
body.dark-mode .signature-area {
  background-color: #1e1e1e !important;
  color: #f5f5f5 !important;
  border-color: #333 !important;
}

body.dark-mode .section-header {
  background-color: #222 !important;
  color: #ffffff !important;
}

body.dark-mode .app-header {
  background-color: #000000;
}

body.dark-mode .form-control::placeholder {
  color: #ccc;
}

body.dark-mode .step-number {
  background-color: #444;
  color: #fff;
}

body.dark-mode .btn {
  background-color: #333;
  color: white;
}

body.dark-mode .btn-primary {
  background-color: #444 !important;
}

body.dark-mode .btn-submit {
  background-color: #2ecc71;
}
/* ‚úÖ ÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ÿÆÿßÿµÿ© ÿ®ÿßŸÑÿ∑ÿ®ÿßÿπÿ© */
@media print {
  body {
    background-color: white !important;
    color: black !important;
  }

  .app-header,
  .btn,
  .navigation-buttons,
  .mobile-menu,
  .desktop-menu,
  #btn-dashboard,
  #btn-deconnexion,
  #btn-nouveau,
  #toggle-theme,
  #burger-dropdown,
  #burger-btn {
    display: none !important;
  }

  .form-section {
    box-shadow: none !important;
    border: none !important;
  }

  .section {
    background: white !important;
    color: black !important;
  }

  canvas {
    display: none !important;
  }

  .signature-area::after {
    content: "Signature pr√©sente dans la version num√©rique.";
    color: gray;
    font-style: italic;
    font-size: 0.8rem;
  }
}

    </style>
    <!-- Firebase SDK -->
     <!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
  let operatorSignaturePad = null;
  let supervisorSignaturePad = null;
  let stockageSignaturePad = null;
</script>

<script>
  
  
  const firebaseConfig = {
    apiKey: "AIzaSyBYWRuK9PheGCZzr19735kgB1FC-V4zyio",
    authDomain: "sterilizationapp.firebaseapp.com",
    projectId: "sterilizationapp",
    storageBucket: "sterilizationapp.appspot.com",
    messagingSenderId: "832991576655",
    appId: "1:832991576655:web:457b8a44b5ea864e4b603a",
    databaseURL: "https://sterilizationapp-default-rtdb.firebaseio.com"
  };

  // Initialiser Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();


    
  
    window.addEventListener("DOMContentLoaded", function () {
      const loginBtn = document.getElementById("login-btn");
      // ‚úÖ ÿ™ŸÅÿπŸäŸÑ ÿ™ŸàŸÇŸäÿπ ÿßŸÑŸäÿØ ÿ®ÿπÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©

  
      loginBtn.addEventListener("click", function () {
        const id = document.getElementById("username").value;
        const mdp = document.getElementById("password").value;

        // ÿ•ÿ∂ÿßŸÅÿ© console.log ŸÑŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÇŸäŸÖ ÿßŸÑŸÖÿØÿÆŸÑÿ©
  console.log("Identifiant:", id); // ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿØÿÆŸÑ
  console.log("Mot de passe:", mdp); // ÿ∑ÿ®ÿßÿπÿ© ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ÿßŸÑŸÖÿØÿÆŸÑÿ©
  
        const dbRef = firebase.database().ref("utilisateurs/" + id);

        
  // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ŸÄ Firebase
  console.log("Firebase Reference:", dbRef);

dbRef.once("value").then((snapshot) => {
  if (snapshot.exists()) {
    const motdepasse = snapshot.val().motdepasse;
    console.log("Mot de passe en base de donn√©es:", motdepasse);
    if (motdepasse === mdp) {
      document.getElementById("message").innerText = "Connexion r√©ussie !";
      document.getElementById("welcome-page").classList.add("hidden");
      document.getElementById("app-container").classList.remove("hidden");
      localStorage.setItem("utilisateurConnecte", id);
    } else {
      document.getElementById("message").innerText = "Mot de passe incorrect !";
    }
  } else {
    document.getElementById("message").innerText = "Identifiant introuvable !";
  }
}).catch((error) => {
  console.error("Erreur:", error);
  document.getElementById("message").innerText = "Erreur: " + error.message;
});

      });
    });
  


  </script>
  
  
  


  
  
  
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <!-- jsPDF & html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


</head>
<body>
    <div id="loading-indicator" class="hidden">Chargement...</div>

    <!-- Page d'accueil -->
    <div class="welcome-page" id="welcome-page">
        <div class="logo-container">
            <div class="logo">OS201</div>
        </div>
        <h1 class="welcome-title">IFMSASO</h1>
        <p class="welcome-subtitle">Application de Tra√ßabilit√© en St√©rilisation</p>
        
        <div class="login-form">
            <div class="form-group">
                <label for="username">Identifiant</label>
                <input type="text" id="username" class="form-control" placeholder="Entrez votre identifiant">
            </div>
            <div class="form-group">
                <label for="password">Mot de passe</label>
                <input type="password" id="password" class="form-control" placeholder="Entrez votre mot de passe">
            </div>
            <button class="login-btn" id="login-btn">Se connecter</button>
            <p id="message" style="color:red; text-align:center;"></p>

        </div>
        
        <div class="version-info">Version 2.0.0 | Centre de simulation IFMSASO</div>
    </div>

    <!-- Application principale -->
    <div class="app-container hidden" id="app-container">
        <div class="app-header">
            <h1 class="app-title">IFMSASO(OS201)</h1>
            <p class="app-subtitle">Tra√ßabilit√© en St√©rilisation</p>
          

            <!-- ‚úÖ Boutons desktop -->
<div class="desktop-menu">
  <button class="btn btn-primary" id="btn-dashboard">üìä Voir Dashboard</button>
  <button class="btn btn-primary" id="btn-deconnexion">üîì D√©connexion</button>
  <button class="btn btn-primary" id="btn-nouveau">üÜï Nouvelle fiche</button>
  <button class="btn btn-primary" id="toggle-theme">üåì Mode Sombre</button>
</div>

<!-- ‚úÖ Burger Menu mobile -->
<div class="mobile-menu">
  <button class="btn btn-primary" id="burger-btn">‚ò∞ Menu</button>
  <div id="burger-dropdown" class="hidden" style="position: absolute; background: white; top: 60px; right: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 6px; padding: 10px;">
    <button class="btn" id="burger-dashboard">üìä Voir Dashboard</button><br>
    <button class="btn" id="burger-nouveau">üÜï Nouvelle fiche</button><br>
    <button class="btn" id="burger-deconnexion">üîì D√©connexion</button>
    <button class="btn" id="burger-theme">üåì Mode Sombre</button>

  </div>
</div>



        </div>
        
        <div class="app-content">
            <div class="form-header">
                <span class="code-number">Code fiche: TR150424-8678</span>
                <span class="form-title">Tra√ßabilit√© de la phase de r√©ception, tri et nettoyage</span>
            </div>
            
            <div class="form-date">
                <label for="date">Date:</label>
                <input type="date" id="date" name="date" value="2025-04-16">
            </div>

            <div class="step-indicator">
              <div class="step active" data-index="0">
                <div class="step-number">1</div>
                <div class="step-label">R√©ception</div>
              </div>
              <div class="step" data-index="1">
                <div class="step-number">2</div>
                <div class="step-label">Tri</div>
              </div>
              <div class="step" data-index="2">
                <div class="step-number">3</div>
                <div class="step-label">Nettoyage</div>
              </div>
              <div class="step" data-index="3">
  <div class="step-number">4</div>
  <div class="step-label">Stockage</div>
</div>
<div class="step" data-index="4">
  <div class="step-number">5</div>
  <div class="step-label">Validation</div>
</div>

              
            </div>

            <div class="warning-banner">
                EPI obligatoires: Lunette de protection, callot, masque, surblouse, surchaussure, gants avec manchettes langue
            </div>
            
            <!-- Section 1: R√©ception -->
            <div class="form-section active" id="section-reception">
                <div class="section">
                    <div class="section-header">1. R√©ception</div>
                    <div class="section-content">
                      <div class="form-group">
                        <label for="photo">üì∏ Photo de l'appareil</label>
                        <input type="file" id="photo" accept="image/*" class="form-control" />
                      </div>
                      
                        <div class="form-group">
                            <label for="arrival-time">Heure d'arriv√©e</label>
                            <input type="time" id="arrival-time" class="form-control" value="10:30">
                        </div>
                        
                        <div class="form-group">
                            <label for="service">Service utilisateur</label>
                            <select id="service" class="form-control">
                                <option value="">S√©lectionner...</option>
                                <option value="chirurgie" selected>Chirurgie</option>
                                <option value="urgences">Urgences</option>
                                <option value="bloc-op">Bloc op√©ratoire</option>
                                <option value="consult">Consultations</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                        <div class="form-group">
                          <label for="type-boite">Type de bo√Æte</label>
                          <select id="type-boite" class="form-control">
                          <option value="">S√©lectionner...</option>
                          <option value="Bo√Æte √† appendicectomie">Bo√Æte √† appendicectomie</option>
                          <option value="Bo√Æte de chirurgie visc√©rale">Bo√Æte de chirurgie visc√©rale</option>
                          <option value="Bo√Æte de chirurgie g√©n√©rale">Bo√Æte de chirurgie g√©n√©rale</option>
                          <option value="Bo√Æte d‚Äôurgence">Bo√Æte d‚Äôurgence</option>
                          <option value="Bo√Æte de laparotomie">Bo√Æte de laparotomie</option>
                          <option value="Bo√Æte de suture">Bo√Æte de suture</option>
                          <option value="Bo√Æte de gyn√©cologie">Bo√Æte de gyn√©cologie</option>
                          <option value="Bo√Æte d‚Äôexploration abdominale">Bo√Æte d‚Äôexploration abdominale</option>
                        </select>
                  </div>
                        <div class="form-group">
                            <label for="transport">Type de transport</label>
                            <select id="transport" class="form-control">
                                <option value="">S√©lectionner...</option>
                                <option value="chariot" selected>Chariot</option>
                                <option value="monte-charge">Monte-charge</option>
                                <option value="pneumatique">Transport pneumatique</option>
                                <option value="manuel">Manuel</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                      

                        
                        <div class="form-group">
                            <label>Risque particulier</label>
                            <div class="checkbox-group">
                                <div class="checkbox-option">
                                    <input type="checkbox" id="risk-prion" name="risk">
                                    <label for="risk-prion">Prion</label>
                                </div>
                                <div class="checkbox-option">
                                    <input type="checkbox" id="risk-other" name="risk">
                                    <label for="risk-other">Autre</label>
                                </div>
                            </div>
                            <input type="text" class="form-control" placeholder="Pr√©ciser autre risque" style="margin-top: 10px; display: none;">
                        </div>
                        
                        <div class="form-group">
                            <label>Pr√©traitement</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="pretreatment-done" name="pretreatment" checked>
                                    <label for="pretreatment-done">Fait</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="pretreatment-not-done" name="pretreatment">
                                    <label for="pretreatment-not-done">Non-fait</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="reception-observations">Observations</label>
                            <textarea id="reception-observations" class="form-control" placeholder="Saisir vos observations..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="nav-button prev-button" disabled>Pr√©c√©dent</button>
                    <button class="nav-button next-button">Suivant</button>
                </div>
            </div>
            
            <!-- Section 2: Tri -->
            <div class="form-section" id="section-tri">
                <div class="section">
                    <div class="section-header">2. Tri</div>
                    <div class="section-content">
                        <div class="form-group">
                            <label>Protocole de nettoyage</label>
                            <div class="checkbox-group">
                                <div class="checkbox-option">
                                    <input type="checkbox" id="protocol-manual" name="protocol" checked>
                                    <label for="protocol-manual">Manuelle</label>
                                </div>
                                <div class="checkbox-option">
                                    <input type="checkbox" id="protocol-washer" name="protocol">
                                    <label for="protocol-washer">Laveur-d√©sinfecteur</label>
                                </div>
                                <div class="checkbox-option">
                                    <input type="checkbox" id="protocol-ultrasound" name="protocol">
                                    <label for="protocol-ultrasound">Ultrasons</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>V√©rification de la quantit√©</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="quantity-complete" name="quantity" checked>
                                    <label for="quantity-complete">Complet</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="quantity-incomplete" name="quantity">
                                    <label for="quantity-incomplete">Non complet</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Qualit√©</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="quality-ok" name="quality" checked>
                                    <label for="quality-ok">Rien √† signaler</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="quality-damaged" name="quality">
                                    <label for="quality-damaged">Endommag√©</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="quality-rusty" name="quality">
                                    <label for="quality-rusty">Rouill√©</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="sorting-observations">Observations</label>
                            <textarea id="sorting-observations" class="form-control" placeholder="Saisir vos observations..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="nav-button prev-button">Pr√©c√©dent</button>
                    <button class="nav-button next-button">Suivant</button>
                </div>
            </div>
            
            <!-- Section 3: Nettoyage -->
            <div class="form-section" id="section-nettoyage">
                <div class="section">
                    <div class="section-header">3. Nettoyage</div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="cleaning-product">Produit de nettoyage utilis√©</label>
                            <select id="cleaning-product" class="form-control">
                                <option value="">S√©lectionner...</option>
                                <option value="product1" selected>Hexanios G+R</option>
                                <option value="product2">Aniosyme DD1</option>
                                <option value="product3">Aniosyme XL3</option>
                                <option value="product4">Autre</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Temp√©rature</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="temp-35-45" name="temperature" checked>
                                    <label for="temp-35-45">35¬∞~45¬∞C</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="temp-40-60" name="temperature">
                                    <label for="temp-40-60">40¬∞~60¬∞C</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="temp-50-60" name="temperature">
                                    <label for="temp-50-60">50¬∞~60¬∞C</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Rin√ßage</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="rinse-yes" name="rinse" checked>
                                    <label for="rinse-yes">Oui</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="rinse-no" name="rinse">
                                    <label for="rinse-no">Non</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>S√©chage</label>
                            <div class="radio-group">
                                <div class="radio-option">
                                    <input type="radio" id="drying-auto" name="drying" checked>
                                    <label for="drying-auto">Oui - Automatique</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="drying-manual" name="drying">
                                    <label for="drying-manual">Oui - Manuelle</label>
                                </div>
                                <div class="radio-option">
                                    <input type="radio" id="drying-no" name="drying">
                                    <label for="drying-no">Non</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="cleaner-name">Nom</label>
                            <input type="text" id="cleaner-name" class="form-control" placeholder="Nom de l'op√©rateur">
                        </div>
                        
                        <div class="form-group">
                            <label for="cleaning-observations">Observations</label>
                            <textarea id="cleaning-observations" class="form-control" placeholder="Saisir vos observations..."></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="nav-button prev-button">Pr√©c√©dent</button>
                    <button class="nav-button next-button">Suivant</button>
                </div>
            </div>
            <!-- Section 4: Stockage et Distribution -->
<div class="form-section" id="section-stockage">
  <div class="section">
    <div class="section-header">4. Stockage et Distribution</div>
    <div class="section-content">

      <div class="form-group">
        <label for="agent-stockage">Nom de l'agent responsable</label>
        <input type="text" id="agent-stockage" class="form-control" placeholder="Nom complet">
      </div>

      <div class="form-group">
        <label for="logiciel">Logiciel utilis√©</label>
        <select id="logiciel" class="form-control">
          <option value="">S√©lectionner...</option>
          <option value="STERIGEST">STERIGEST</option>
          <option value="OPERA">OPERA</option>
          <option value="HOSPILOG">HOSPILOG</option>
          <option value="AUTRE">Autre</option>
        </select>
      </div>

      <div class="form-group">
        <label for="quantite-stockee">Quantit√© stock√©e</label>
        <input type="text" id="quantite-stockee" class="form-control" placeholder="Ex: 25 unit√©s">
      </div>

      <div class="form-group">
        <label for="date-stockage">Date de stockage</label>
        <input type="date" id="date-stockage" class="form-control">
      </div>

      <div class="form-group">
        <label for="date-distribution">Date de distribution</label>
        <input type="date" id="date-distribution" class="form-control">
      </div>

      <div class="form-group">
        <label for="agent-distribution">Nom de l'agent distributeur</label>
        <input type="text" id="agent-distribution" class="form-control" placeholder="Nom complet">
      </div>
      <div class="form-group">
  <label>Signature de l'agent distributeur</label>
  <div class="signature-area">
    <canvas id="signature-stockage" width="300" height="100" style="background:white; border-radius:4px;"></canvas>
  </div>
  <button class="btn" type="button" onclick="clearSignature('stockage')">Effacer</button>
</div>


    </div>
  </div>

  <div class="navigation-buttons">
    <button class="nav-button prev-button">Pr√©c√©dent</button>
    <button class="nav-button next-button">Suivant</button>
  </div>
</div>

            <!-- Section 5: Validation -->
            <div class="form-section" id="section-validation">
                <div class="section">
                    <div class="section-header">5. Validation</div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="operator-name">Nom de l'op√©rateur</label>
                            <input type="text" id="operator-name" class="form-control" placeholder="Nom complet">
                        </div>
                        <div class="form-group">
                            <label for="phase">Phase :</label>
                            <select id="phase" class="form-control">
                              <option value="R√©ception">R√©ception</option>
                              <option value="Lavage">Lavage</option>
                              <option value="St√©rilisation">St√©rilisation</option>
                              <option value="Stockage">Stockage</option>
                            </select>
                          </div>
                          <div class="form-group">
                            <button id="save-button"
                            class="btn-submit">Enregistrer</button>
                          </div>
                          <div class="form-group">
                            <button class="btn btn-primary" onclick="exportToPDF()">üñ®Ô∏è T√©l√©charger PDF</button>
                          </div>
                          
                          

                          
                        
                        <div class="form-group">
                            <label>Signature de l'op√©rateur</label>
                            <div class="signature-area">
                                <canvas class="signature-canvas" width="300" height="100" style="background:white; border-radius:4px;"></canvas>
                              </div>
                              <button class="btn" type="button" onclick="clearSignature('operator')">Effacer</button>
                              
                        </div>
                        
                        <div class="form-group">
                            <label for="supervisor-name">Nom du responsable</label>
                            <input type="text" id="supervisor-name" class="form-control" placeholder="Nom complet">
                        </div>
                        
                        <div class="form-group">
                            <label>Signature du responsable</label>
                            <div class="signature-area">
                                <canvas class="signature-canvas" width="300" height="100" style="background:white; border-radius:4px;"></canvas>
                              </div>
                              <button class="btn" type="button" onclick="clearSignature('supervisor')">Effacer</button>

                              
                        </div>
                        
                        <div class="form-group">
                            <p style="font-weight: 500; color: #e74c3c;">Remarque: Tout dispositif non conforme doit √™tre isol√© et signal√© imm√©diatement au responsable du service</p>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button class="nav-button prev-button">Pr√©c√©dent</button>
                    <button class="btn btn-submit">Enregistrer</button>
                </div>
            </div>
            <!-- Section 5: Dashboard -->
<div class="section" id="dashboard-section" style="display: none;">
    <div class="section-header">üìã Tableau de Suivi des Fiches</div>
    <div class="section-content">
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="date" id="filtre-date" class="form-control" />
            <select id="filtre-service" class="form-control">
              <option value="">Tous les services</option>
              <option value="chirurgie">Chirurgie</option>
              <option value="urgences">Urgences</option>
              <option value="bloc-op">Bloc op√©ratoire</option>
              <option value="consult">Consultations</option>
              <option value="autre">Autre</option>
            </select>
            <button class="btn btn-primary" id="btn-filtrer">üîç Appliquer le filtre</button>
          </div>
          
        <div id="dashboard-list">
        <p>Chargement des donn√©es...</p>
      </div>
      <button class="btn btn-primary" id="btn-retour" style="margin-top: 20px;">‚¨ÖÔ∏è Retour au formulaire</button>
      <button class="btn btn-submit" id="btn-export" style="margin-top: 10px;">üì• Exporter vers Excel</button>


    </div>
    <div id="dashboard-charts" style="margin-top: 30px;">
        <h3>üìä Statistiques</h3>
        <!-- ‚úÖ Statistiques g√©n√©rales -->
        <div class="stats-box">
          <p id="pourcentage-signature">Pourcentage fiches sign√©es: ...</p>
          <p id="fiches-incompletes">Fiches incompl√®tes: ...</p>
          <p id="fiches-semaine">Fiches cette semaine: ...</p>
          <p id="fiches-mois">Fiches ce mois: ...</p>
        </div>
        

        <canvas id="serviceChart" style="max-height: 300px;"></canvas>
        <canvas id="phaseChart" style="max-height: 300px; margin-top: 40px;"></canvas>
        <canvas id="transportChart" style="max-height: 300px; margin-top: 40px;"></canvas>
<canvas id="produitChart" style="max-height: 300px; margin-top: 40px;"></canvas>
<canvas id="operateurChart" style="max-height: 300px; margin-top: 40px;"></canvas>

      </div>
      
  </div>
  
        </div>
    </div>

    <script>
      // ÿπŸÜÿØ ÿ®ÿØÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase
function showLoader(isVisible) {
  const loader = document.getElementById("loading-indicator");
  if (isVisible) {
    loader.classList.remove("hidden");
  } else {
    loader.classList.add("hidden");
  }
}

document.getElementById('btn-dashboard').addEventListener('click', () => {
  const dashboardList = document.getElementById('dashboard-list');
  dashboardList.innerHTML = '<p>Chargement...</p>';
  showLoader(true); // ÿ•ÿ∏Ÿáÿßÿ± ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ

  firebase.database().ref('fiches').limitToLast(20).once('value')
    .then(snapshot => {
      const fiches = snapshot.val();
      dashboardList.innerHTML = ''; // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
      if (!fiches) {
        dashboardList.innerHTML = '<p>Aucune fiche trouv√©e.</p>';
      } else {
        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸáŸÜÿß
        Object.entries(fiches).forEach(([id, fiche]) => {
          const ficheDiv = document.createElement("div");
          ficheDiv.innerHTML = `
            <p><strong>Date:</strong> ${fiche.date || '---'}</p>
            <p><strong>Service:</strong> ${fiche.reception?.service || '---'}</p>
            <!-- ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ŸáŸÜÿß -->
          `;
          dashboardList.appendChild(ficheDiv);
        });
      }
      showLoader(false); // ÿ•ÿÆŸÅÿßÿ° ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ÿπÿØ ÿßŸÉÿ™ŸÖÿßŸÑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
    })
    .catch(error => {
      console.error('Erreur lors du chargement:', error);
      dashboardList.innerHTML = '<p style="color:red;">Erreur lors du chargement des fiches.</p>';
      showLoader(false); // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÖÿ§ÿ¥ÿ± ŸÅŸä ÿ≠ÿßŸÑ ÿ≠ÿØŸàÿ´ ÿÆÿ∑ÿ£
    });
});


        
        document.addEventListener('DOMContentLoaded', function() {
            const utilisateurConnecte = localStorage.getItem("utilisateurConnecte");
            if (utilisateurConnecte) {
  document.getElementById('welcome-page').classList.add('hidden');
  document.getElementById('app-container').classList.remove('hidden');

  


  // ‚úÖ Commencer depuis le d√©but du formulaire
  currentSection = 0;
  updateSections();
  alert("üîê Connexion automatique en tant que: " + utilisateurConnecte);

}
// ‚úÖ Boutons header
document.getElementById("btn-deconnexion")?.addEventListener("click", function () {
  localStorage.removeItem("utilisateurConnecte");
  document.getElementById("app-container").classList.add("hidden");
  document.getElementById("welcome-page").classList.remove("hidden");
});

document.getElementById("btn-nouveau")?.addEventListener("click", () => {
  const confirmation = confirm("‚ö†Ô∏è Voulez-vous vraiment cr√©er une nouvelle fiche ?");
  if (!confirmation) return;
  localStorage.removeItem("ficheEnEdition");
  resetForm();
  document.getElementById("btn-retour").click();
  showToast("üÜï Nouvelle fiche r√©initialis√©e !");
});



document.getElementById("toggle-theme")?.addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  const isDark = document.body.classList.contains("dark-mode");
  localStorage.setItem("theme", isDark ? "dark" : "light");
});

setTimeout(() => {
  const canvases = document.querySelectorAll('.signature-canvas');
  if (canvases.length >= 2) {
    operatorSignaturePad = new SignaturePad(canvases[0]);
    supervisorSignaturePad = new SignaturePad(canvases[1]);
  }
}, 500); // ŸÜŸÜÿ™ÿ∏ÿ± ŸÜÿµŸÅ ÿ´ÿßŸÜŸäÿ© ÿ≠ÿ™Ÿâ ÿ™ÿ∏Ÿáÿ± ÿßŸÑÿπŸÜÿßÿµÿ±
setTimeout(() => {
  const stockageCanvas = document.getElementById('signature-stockage');
  if (stockageCanvas) {
    stockageSignaturePad = new SignaturePad(stockageCanvas);
  }
}, 600);





});

            // Connexion √† l'application
            const loginBtn = document.getElementById('login-btn');
            const welcomePage = document.getElementById('welcome-page');
            const appContainer = document.getElementById('app-container');
            
            loginBtn.addEventListener("click", function () {
  const identifiant = document.getElementById("username").value;
  const motdepasse = document.getElementById("password").value;

  const dbRef = firebase.database().ref("utilisateurs/" + identifiant);

  dbRef.once("value")
    .then((snapshot) => {
      if (snapshot.exists()) {
        const data = snapshot.val();
        console.log("Data fetched from Firebase:", data);  // ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿ±ÿ¨ÿπÿ©
        
        if (data.motdepasse === motdepasse) {
          // Connexion r√©ussie
          localStorage.setItem("utilisateurConnecte", identifiant); // üîê Enregistrer la session
          welcomePage.classList.add("hidden");
          appContainer.classList.remove("hidden");
        } else {
          document.getElementById("message").innerText = "Mot de passe incorrect !";
        }
      } else {
        alert("Identifiant introuvable !");
      }
    })
    .catch((error) => {
      console.error("Erreur lors de la connexion:", error);
      document.getElementById("message").innerText = "Erreur: " + error.message;
    });
});



            
            // Navigation entre sections
            const sections = Array.from(document.querySelectorAll('.form-section')).filter(
  section => section.id !== "dashboard-section"
);

            const steps = document.querySelectorAll('.step');
            const nextButtons = document.querySelectorAll('.next-button');
            const prevButtons = document.querySelectorAll('.prev-button');
            
            let currentSection = 0;
            
            function updateSections() {
                sections.forEach((section, index) => {
                    section.classList.toggle('active', index === currentSection);
                });
                
                steps.forEach((step, index) => {
                    step.classList.toggle('active', index === currentSection);
                    step.classList.toggle('completed', index < currentSection);
                });
                // ‚úÖ ÿ•ÿπÿßÿØÿ© ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ŸàÿßŸÇŸäÿπ ÿ•ÿ∞ÿß ŸàÿµŸÑŸÜÿß ŸÑŸÇÿ≥ŸÖ Validation
if (currentSection === sections.length - 1) {
  setTimeout(() => {
    const canvases = document.querySelectorAll('.signature-canvas');
    if (canvases.length >= 2) {
      operatorSignaturePad = new SignaturePad(canvases[0]);
      supervisorSignaturePad = new SignaturePad(canvases[1]);
    }
  }, 300);
}

            }
            steps.forEach((step) => {
  step.addEventListener("click", () => {
    const index = parseInt(step.getAttribute("data-index"));
    if (!isNaN(index)) {
      currentSection = index;
      updateSections();
    }
  });
});

            
            nextButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (currentSection < sections.length - 1) {
                        currentSection++;
                        updateSections();
                    }
                });
            });
            
            prevButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (currentSection > 0) {
                        currentSection--;
                        updateSections();
                    }
                });
            });
            
            // Afficher le champ "autre risque" quand la case est coch√©e
            const riskOtherCheckbox = document.getElementById('risk-other');
            const otherRiskField = riskOtherCheckbox.closest('.form-group').querySelector('input[type="text"]');
            
            riskOtherCheckbox.addEventListener('change', function() {
                otherRiskField.style.display = this.checked ? 'block' : 'none';
            });
            
            // Bouton d'enregistrement
            document.querySelector('.btn-submit').addEventListener('click', function () {
              // üõë Emp√™cher les enregistrements r√©p√©t√©s dans moins de 60 secondes
const now = Date.now();
const lastSaveTime = localStorage.getItem("lastSaveTime");

if (lastSaveTime && now - lastSaveTime < 60000) {
  showModal("‚è±Ô∏è Veuillez patienter au moins une minute avant d'enregistrer une nouvelle fiche.");
  return;
}

              // ‚úÖ V√©rification des champs obligatoires (hors observations)
const champsObligatoires = [
  "date",                   // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÅŸäÿ¥ÿ©
  "arrival-time",           // ÿ≥ÿßÿπÿ© ÿßŸÑŸàÿµŸàŸÑ
  "service",                // ÿßŸÑÿÆÿØŸÖÿ© ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ©
  "transport",              // ŸÜŸàÿπ ÿßŸÑŸÜŸÇŸÑ
  "cleaner-name",           // ÿßÿ≥ŸÖ ÿπÿßŸÖŸÑ ÿßŸÑÿ™ŸÜÿ∏ŸäŸÅ

  // ‚¨áÔ∏è ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÄ stockage
  "agent-stockage",         // ÿßÿ≥ŸÖ ŸÖÿ≥ÿ§ŸàŸÑ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ
  "logiciel",               // logiciel utilis√©
  "quantite-stockee",       // quantit√© stock√©e
  "date-stockage",          // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ
  "date-distribution",      // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™Ÿàÿ≤Ÿäÿπ
  "agent-distribution",     // ÿßÿ≥ŸÖ ÿßŸÑŸÖŸàÿ≤ÿπ

  "operator-name",          // ÿßÿ≥ŸÖ ÿπÿßŸÖŸÑ ÿßŸÑÿ™ŸàŸÇŸäÿπ
  "supervisor-name"         // ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ
];



let champVide = false;

champsObligatoires.forEach(id => {
  const champ = document.getElementById(id);
  if (champ && champ.value.trim() === "") {
    champ.style.border = "2px solid red"; // surligner le champ vide
    champVide = true;
  } else if (champ) {
    champ.style.border = ""; // retirer le surlignage si rempli
  }
});

// ‚úÖ V√©rification des signatures (incluant stockage)
const signatureVide =
  operatorSignaturePad?.isEmpty() ||
  supervisorSignaturePad?.isEmpty() ||
  stockageSignaturePad?.isEmpty();


if (champVide) {
  showModal("‚ö†Ô∏è Veuillez remplir tous les champs obligatoires.");
  return;
}

if (signatureVide) {
  showModal("‚úçÔ∏è Veuillez ajouter les deux signatures avant de valider.");
  return;
}


  const data = {
    date: document.getElementById('date')?.value || "",
    phase: document.getElementById('phase')?.value || "R√©ception",

    reception: {
      arrivalTime: document.getElementById('arrival-time')?.value || "",
      service: document.getElementById('service')?.value || "",
      boite: document.getElementById('type-boite')?.value || "",
      transport: document.getElementById('transport')?.value || "",
      risks: {
        prion: document.getElementById('risk-prion')?.checked || false,
        autre: document.getElementById('risk-other')?.checked || false,
        autreText: document.querySelector('#risk-other')?.closest('.form-group').querySelector('input[type="text"]')?.value || ""
      },
      pretreatment: document.getElementById('pretreatment-done')?.checked ? "Fait" : "Non-fait",
      observations: document.getElementById('reception-observations')?.value || ""
    },

    tri: {
      protocol: {
        manual: document.getElementById('protocol-manual')?.checked || false,
        washer: document.getElementById('protocol-washer')?.checked || false,
        ultrasound: document.getElementById('protocol-ultrasound')?.checked || false,
      },
      quantity: document.getElementById('quantity-complete')?.checked ? "Complet" : "Non complet",
      quality: document.getElementById('quality-ok')?.checked
        ? "Rien √† signaler"
        : document.getElementById('quality-damaged')?.checked
          ? "Endommag√©"
          : "Rouill√©",
      observations: document.getElementById('sorting-observations')?.value || ""
    },

    nettoyage: {
      product: document.getElementById('cleaning-product')?.value || "",
      temperature:
        document.getElementById('temp-35-45')?.checked ? "35¬∞~45¬∞C" :
        document.getElementById('temp-40-60')?.checked ? "40¬∞~60¬∞C" :
        "50¬∞~60¬∞C",
      rinse: document.getElementById('rinse-yes')?.checked ? "Oui" : "Non",
      drying:
        document.getElementById('drying-auto')?.checked ? "Automatique" :
        document.getElementById('drying-manual')?.checked ? "Manuelle" :
        "Non",
      cleanerName: document.getElementById('cleaner-name')?.value || "",
      observations: document.getElementById('cleaning-observations')?.value || ""
    },
    stockage: {
  agentResponsable: document.getElementById('agent-stockage')?.value || "",
  logiciel: document.getElementById('logiciel')?.value || "",
  quantite: document.getElementById('quantite-stockee')?.value || "",
  dateStockage: document.getElementById('date-stockage')?.value || "",
  dateDistribution: document.getElementById('date-distribution')?.value || "",
  agentDistribution: document.getElementById('agent-distribution')?.value || "",
  signatureDistribution: stockageSignaturePad?.isEmpty() ? "Non disponible" : stockageSignaturePad.toDataURL()

},

    validation: {
      operatorName: document.getElementById('operator-name')?.value || "",
      supervisorName: document.getElementById('supervisor-name')?.value || "",
      phase: document.getElementById('phase')?.value || "",
      operatorSignature: operatorSignaturePad.isEmpty() ? "Non disponible" : operatorSignaturePad.toDataURL(),
supervisorSignature: supervisorSignaturePad.isEmpty() ? "Non disponible" : supervisorSignaturePad.toDataURL()

    },

    dateSaved: new Date().toISOString()
  };

  // ‚úÖ ÿ™ÿ≠ŸÇŸÇ ŸáŸÑ ŸÜÿ≠ŸÜ ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿ£Ÿà ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ÿØŸäÿØÿ©
  const idEdition = localStorage.getItem("ficheEnEdition");
  const ref = idEdition
    ? firebase.database().ref('fiches/' + idEdition)
    : firebase.database().ref('fiches').push();

    const file = document.getElementById("photo").files[0];
if (file) {
  const storageRef = firebase.storage().ref("photos/" + Date.now() + "_" + file.name);
  storageRef.put(file).then(snapshot => {
    snapshot.ref.getDownloadURL().then(url => {
      data.photoUrl = url; // ŸÜÿ±ÿ®ÿ∑ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
      ref.set(data).then(() => {
        showToast("‚úÖ Donn√©es + photo enregistr√©es !");
        localStorage.setItem("lastSaveTime", Date.now());
        localStorage.removeItem("ficheEnEdition");
        setTimeout(() => {
          document.getElementById("btn-dashboard").click();
        }, 1000);
      });
    });
  });
} else {
  ref.set(data).then(() => {
    showToast("‚úÖ Donn√©es enregistr√©es sans photo !");
    localStorage.setItem("lastSaveTime", Date.now());
    localStorage.removeItem("ficheEnEdition");
    setTimeout(() => {
      document.getElementById("btn-dashboard").click();
    }, 1000);
  });
}

        localStorage.setItem("lastSaveTime", Date.now());
ficheEstSauvegardee = true;

      localStorage.removeItem("ficheEnEdition"); // ŸÖÿ≥ÿ≠ Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿ®ÿπÿØ ÿßŸÑÿ≠ŸÅÿ∏
      // ‚úÖ Aller automatiquement au Dashboard apr√®s 1s
    setTimeout(() => {
      document.getElementById("btn-dashboard").click();
    }, 1000);
    })
    .catch((error) => {
      console.error("‚ùå Erreur lors de l'enregistrement :", error);
    });


  


document.getElementById('btn-dashboard').addEventListener('click', () => {
  const dashboard = document.getElementById('dashboard-section');
  dashboard.style.display = 'block';
  document.querySelectorAll('.form-section').forEach(section => section.style.display = 'none');

  const dashboardList = document.getElementById('dashboard-list');
  dashboardList.innerHTML = '<p>Chargement...</p>';
  showLoader(true);


  // ‚úÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase


  firebase.database().ref('fiches').limitToLast(20).once('value')
    .then(snapshot => {
      const fiches = snapshot.val();
      dashboardList.innerHTML = '';

      if (!fiches) {
        dashboardList.innerHTML = '<p>Aucune fiche trouv√©e.</p>';
        showLoader(false);
        return;
      }
      if (fiches) genererStatistiques(fiches);

      Object.entries(fiches).forEach(([id, fiche]) => {
        const ficheDiv = document.createElement("div");

// ‚úÖ ÿ™ÿ≠ÿØŸäÿØ ÿ•ÿ∞ÿß ŸÉŸÜÿß ŸÅŸä ÿßŸÑŸàÿ∂ÿπ ÿßŸÑŸÑŸäŸÑŸä
const isDarkMode = document.body.classList.contains('dark-mode');

// ‚úÖ ÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ÿØŸäŸÜÿßŸÖŸäŸÉŸäÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸàÿ∂ÿπ
ficheDiv.style.border = '1px solid ' + (isDarkMode ? '#444' : '#ccc');
ficheDiv.style.padding = '10px';
ficheDiv.style.marginBottom = '10px';
ficheDiv.style.borderRadius = '6px';
ficheDiv.style.backgroundColor = isDarkMode ? '#1e1e1e' : '#f9f9f9';
ficheDiv.style.color = isDarkMode ? '#f5f5f5' : '#2c3e50';



ficheDiv.innerHTML = `
  <p><strong>Date:</strong> ${fiche.date || '---'}</p>
  <p><strong>Service:</strong> ${fiche.reception?.service || '---'}</p>
  <p><strong>Type de bo√Æte:</strong> ${fiche.reception?.boite || '---'}</p>
  <p><strong>Transport:</strong> ${fiche.reception?.transport || '---'}</p>
  <p><strong>Observation r√©ception:</strong> ${fiche.reception?.observations || '---'}</p>
  <p><strong>Produit nettoyage:</strong> ${fiche.nettoyage?.product || '---'}</p>
  <p><strong>Op√©rateur:</strong> ${fiche.validation?.operatorName || '---'}</p>
  <p><strong>Phase:</strong> ${fiche.validation?.phase || fiche.phase || '---'}</p>
  ${fiche.photoUrl ? `<img src="${fiche.photoUrl}" style="max-width: 100px; max-height: 100px; border-radius: 6px; margin-top: 10px;">` : ''}
  <p><strong>Responsable Stockage:</strong> ${fiche.stockage?.agentResponsable || '---'}</p>
  <p><strong>Logiciel:</strong> ${fiche.stockage?.logiciel || '---'}</p>
  <p><strong>Quantit√©:</strong> ${fiche.stockage?.quantite || '---'}</p>
  <p><strong>Distributeur:</strong> ${fiche.stockage?.agentDistribution || '---'}</p>
  <p><strong>Date Distribution:</strong> ${fiche.stockage?.dateDistribution || '---'}</p>
  ${fiche.stockage?.signatureDistribution && fiche.stockage.signatureDistribution !== "Non disponible" 
  ? `<img src="${fiche.stockage.signatureDistribution}" style="max-width: 100px; margin-top: 10px; border-radius: 6px;">`
  : '<p><em>Signature distributeur non disponible</em></p>'}

  <button class="btn btn-primary" onclick="modifierFiche('${id}')">‚úèÔ∏è Modifier</button>
  <button class="btn btn-submit" style="background-color:#e74c3c;" onclick="supprimerFiche('${id}')">üóëÔ∏è Supprimer</button>

`;

        dashboardList.appendChild(ficheDiv);
      });
      showLoader(false);
      
    })
    .catch(error => {
      console.error('Erreur lors du chargement:', error);
      dashboardList.innerHTML = '<p style="color:red;">Erreur lors du chargement des fiches.</p>';

      showLoader(false);

      
    });
    

});
document.getElementById('btn-dashboard').addEventListener('click', () => {
  const dashboardList = document.getElementById('dashboard-list');
  dashboardList.innerHTML = '<p>Chargement...</p>';
  showLoader(true); // ÿ•ÿ∏Ÿáÿßÿ± ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ

  let lastKey = null; // ŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ£ÿÆŸäÿ± ÿßŸÑŸÖÿ≠ŸÖŸëŸÑ

  // ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ Firebase ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ÿ¥ŸÉŸÑ ÿ¨ÿ≤ÿ¶Ÿä
  let query = firebase.database().ref('fiches').limitToLast(20); // ÿ™ÿ≠ŸÖŸäŸÑ ÿ¢ÿÆÿ± 20 ÿ≥ÿ¨ŸÑŸãÿß

  // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÑÿØŸäŸÜÿß ŸÖŸÅÿ™ÿßÿ≠ ÿ¢ÿÆÿ± (ÿ£Ÿä ÿ£ŸÜŸÜÿß ŸÇŸÖŸÜÿß ÿ®ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿ≥ÿßÿ®ŸÇÿ©)
  if (lastKey) {
    query = query.startAt(lastKey);  // ÿßŸÑÿ®ÿØÿ° ŸÖŸÜ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ£ÿÆŸäÿ±
  }

  query.once('value')
    .then(snapshot => {
      const fiches = snapshot.val();
      dashboardList.innerHTML = ''; // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
      if (!fiches) {
        dashboardList.innerHTML = '<p>Aucune fiche trouv√©e.</p>';
      } else {
        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸáŸÜÿß
        Object.entries(fiches).forEach(([id, fiche]) => {
          const ficheDiv = document.createElement("div");
          ficheDiv.innerHTML = `
            <p><strong>Date:</strong> ${fiche.date || '---'}</p>
            <p><strong>Service:</strong> ${fiche.reception?.service || '---'}</p>
            <!-- ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ŸáŸÜÿß -->
          `;
          dashboardList.appendChild(ficheDiv);
          lastKey = id; // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ£ÿÆŸäÿ±
        });
      }
      showLoader(false);  // ÿ•ÿÆŸÅÿßÿ° ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
    })
    .catch(error => {
      console.error('Erreur lors du chargement:', error);
      dashboardList.innerHTML = '<p style="color:red;">Erreur lors du chargement des fiches.</p>';
      showLoader(false);  // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÖÿ§ÿ¥ÿ± ŸÅŸä ÿ≠ÿßŸÑ ÿ≠ÿØŸàÿ´ ÿÆÿ∑ÿ£
    });
});



function supprimerFiche(id) {
  const confirmation = confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer cette fiche ?");
  if (confirmation) {
    firebase.database().ref('fiches/' + id).remove()
      .then(() => {
        showToast("‚úÖ Fiche supprim√©e avec succ√®s !");

      })
      .catch((error) => {
        alert("‚ùå Erreur lors de la suppression: " + error.message);
      });
  }
}
function modifierFiche(id) {
  const confirmer = confirm("‚ö†Ô∏è √ätes-vous s√ªr de vouloir modifier cette fiche ?");
  if (!confirmer) return;

  const ficheRef = firebase.database().ref('fiches/' + id);
  ficheRef.once('value')
    .then(snapshot => {
      const fiche = snapshot.val();
      if (!fiche) return;

      // ‚úÖ Afficher le formulaire
      document.getElementById('dashboard-section').style.display = 'none';
      const sections = document.querySelectorAll('.form-section');
      sections.forEach((s, i) => {
        s.style.display = i === 0 ? 'block' : 'none';
        s.classList.toggle('active', i === 0);
      });

      // ‚úÖ R√©ception
      document.getElementById('date').value = fiche.date || "";
      document.getElementById('arrival-time').value = fiche.reception?.arrivalTime || "";
      document.getElementById('service').value = fiche.reception?.service || "";
      document.getElementById('transport').value = fiche.reception?.transport || "";
      document.getElementById('reception-observations').value = fiche.reception?.observations || "";

      // ‚úÖ Tri
      document.getElementById('sorting-observations').value = fiche.tri?.observations || "";
      document.getElementById('quantity-complete').checked = fiche.tri?.quantity === "Complet";
      document.getElementById('quantity-incomplete').checked = fiche.tri?.quantity === "Non complet";
      document.getElementById('quality-ok').checked = fiche.tri?.quality === "Rien √† signaler";
      document.getElementById('quality-damaged').checked = fiche.tri?.quality === "Endommag√©";
      document.getElementById('quality-rusty').checked = fiche.tri?.quality === "Rouill√©";

      document.getElementById('protocol-manual').checked = fiche.tri?.protocol?.manual || false;
      document.getElementById('protocol-washer').checked = fiche.tri?.protocol?.washer || false;
      document.getElementById('protocol-ultrasound').checked = fiche.tri?.protocol?.ultrasound || false;

      // ‚úÖ Nettoyage
      document.getElementById('cleaning-product').value = fiche.nettoyage?.product || "";
      document.getElementById('cleaner-name').value = fiche.nettoyage?.cleanerName || "";
      document.getElementById('cleaning-observations').value = fiche.nettoyage?.observations || "";

      document.getElementById('temp-35-45').checked = fiche.nettoyage?.temperature === "35¬∞~45¬∞C";
      document.getElementById('temp-40-60').checked = fiche.nettoyage?.temperature === "40¬∞~60¬∞C";
      document.getElementById('temp-50-60').checked = fiche.nettoyage?.temperature === "50¬∞~60¬∞C";

      document.getElementById('rinse-yes').checked = fiche.nettoyage?.rinse === "Oui";
      document.getElementById('rinse-no').checked = fiche.nettoyage?.rinse === "Non";

      document.getElementById('drying-auto').checked = fiche.nettoyage?.drying === "Automatique";
      document.getElementById('drying-manual').checked = fiche.nettoyage?.drying === "Manuelle";
      document.getElementById('drying-no').checked = fiche.nettoyage?.drying === "Non";

      // ‚úÖ Validation
      document.getElementById('operator-name').value = fiche.validation?.operatorName || "";
      document.getElementById('supervisor-name').value = fiche.validation?.supervisorName || "";
      document.getElementById('phase').value = fiche.validation?.phase || "";

      // ‚úÖ Signatures (optionnel)
      if (fiche.validation?.operatorSignature) {
        operatorSignaturePad.fromDataURL(fiche.validation.operatorSignature);
      }
      if (fiche.validation?.supervisorSignature) {
        supervisorSignaturePad.fromDataURL(fiche.validation.supervisorSignature);
      }

      // üü° Enregistrer l'identifiant temporairement
      localStorage.setItem("ficheEnEdition", id);
    });
}

document.getElementById('btn-retour').addEventListener('click', () => {
  // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÄ Dashboard
  document.getElementById('dashboard-section').style.display = 'none';

  // ÿ•ÿ∏Ÿáÿßÿ± ŸÇÿ≥ŸÖ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨ ÿßŸÑÿ£ŸàŸÑ
  const allSections = Array.from(document.querySelectorAll('.form-section')).filter(
    section => section.id !== "dashboard-section"
  );

  allSections.forEach((section, index) => {
    section.style.display = index === 0 ? 'block' : 'none';
    section.classList.toggle('active', index === 0);
  });

  // ÿ•ÿπÿßÿØÿ© ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™
  currentSection = 0;
  sections.length = 0;
  sections.push(...allSections);

  // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿÆÿ∑Ÿàÿßÿ™
  const steps = document.querySelectorAll('.step');
  steps.forEach((step, index) => {
    step.classList.toggle('active', index === 0);
    step.classList.remove('completed');
  });

  // ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ™ŸàŸÇŸäÿπ
  setTimeout(() => {
    updateSections();
    const canvases = document.querySelectorAll('.signature-canvas');
    if (canvases.length >= 2) {
      operatorSignaturePad = new SignaturePad(canvases[0]);
      supervisorSignaturePad = new SignaturePad(canvases[1]);
    }
  }, 300);
});





// ‚úÖ Filtrage
document.getElementById("btn-filtrer").addEventListener("click", () => {
  let lastKey = null;  // ŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ£ÿÆŸäÿ± ÿßŸÑÿ∞Ÿä ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑŸá

document.getElementById("btn-filtrer").addEventListener("click", () => {
  const dateFiltre = document.getElementById("filtre-date").value;
  const serviceFiltre = document.getElementById("filtre-service").value;

  const dashboardList = document.getElementById("dashboard-list");
  dashboardList.innerHTML = '<p>Chargement...</p>';
  showLoader(true);

  let query = firebase.database().ref('fiches').limitToLast(20);  // ÿ™ÿ≠ŸÖŸäŸÑ ÿ¢ÿÆÿ± 20 ÿ≥ÿ¨ŸÑŸãÿß

  // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÑÿØŸäŸÜÿß ÿ™ÿßÿ±ŸäÿÆ ŸÅŸÑÿ™ÿ±ÿ©
  if (dateFiltre) {
    query = query.orderByChild('date').equalTo(dateFiltre);  // ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
  }

  // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÑÿØŸäŸÜÿß ŸÅŸÑÿ™ÿ±ÿ© ŸÑŸÑÿÆÿØŸÖÿ©
  if (serviceFiltre) {
    query = query.orderByChild('reception/service').equalTo(serviceFiltre);  // ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿÆÿØŸÖÿ©
  }

  // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÑÿØŸäŸÜÿß ŸÖŸÅÿ™ÿßÿ≠ ÿ¢ÿÆÿ± (ÿ£Ÿä ÿ£ŸÜŸÜÿß ŸÇŸÖŸÜÿß ÿ®ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿ≥ÿßÿ®ŸÇÿ©)
  if (lastKey) {
    query = query.startAt(lastKey);  // ÿßŸÑÿ®ÿØÿ° ŸÖŸÜ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ£ÿÆŸäÿ±
  }

  query.once('value')
    .then(snapshot => {
      const fiches = snapshot.val();
      dashboardList.innerHTML = '';  // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
      if (!fiches) {
        dashboardList.innerHTML = '<p>Aucune fiche trouv√©e.</p>';
      } else {
        Object.entries(fiches).forEach(([id, fiche]) => {
          const ficheDiv = document.createElement("div");
          ficheDiv.innerHTML = `
            <p><strong>Date:</strong> ${fiche.date || '---'}</p>
            <p><strong>Service:</strong> ${fiche.reception?.service || '---'}</p>
            <!-- ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ŸáŸÜÿß -->
          `;
          dashboardList.appendChild(ficheDiv);
          lastKey = id;  // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ£ÿÆŸäÿ±
        });
      }
      showLoader(false);  // ÿ•ÿÆŸÅÿßÿ° ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
    })
    .catch(error => {
      console.error('Erreur lors du chargement:', error);
      dashboardList.innerHTML = '<p style="color:red;">Erreur lors du chargement des fiches.</p>';
      showLoader(false);  // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸÖÿ§ÿ¥ÿ± ŸÅŸä ÿ≠ÿßŸÑ ÿ≠ÿØŸàÿ´ ÿÆÿ∑ÿ£
    });
});

  const dateFiltre = document.getElementById("filtre-date").value;
  const serviceFiltre = document.getElementById("filtre-service").value;

  const dashboardList = document.getElementById("dashboard-list");
  firebase.database().ref('fiches').orderByKey().limitToLast(20).once('value')

    .then(snapshot => {
      const fiches = snapshot.val();
      dashboardList.innerHTML = '';

      if (!fiches) {
        dashboardList.innerHTML = '<p>Aucune fiche trouv√©e.</p>';
        return;
      }

      Object.entries(fiches).forEach(([id, fiche]) => {
        const matchDate = !dateFiltre || fiche.date === dateFiltre;
        const matchService = !serviceFiltre || fiche.reception?.service === serviceFiltre;

        if (matchDate && matchService) {
          const ficheDiv = document.createElement("div");
          ficheDiv.style.border = '1px solid #ccc';
          ficheDiv.style.padding = '10px';
          ficheDiv.style.marginBottom = '10px';
          ficheDiv.style.borderRadius = '6px';
          ficheDiv.style.backgroundColor = document.body.classList.contains('dark-mode') ? '#1e1e1e' : '#f9f9f9';

          ficheDiv.innerHTML = `
            <p><strong>Date:</strong> ${fiche.date || '---'}</p>
            <p><strong>Service:</strong> ${fiche.reception?.service || '---'}</p>
            <p><strong>Transport:</strong> ${fiche.reception?.transport || '---'}</p>
            <p><strong>Observation r√©ception:</strong> ${fiche.reception?.observations || '---'}</p>
            <p><strong>Produit nettoyage:</strong> ${fiche.nettoyage?.product || '---'}</p>
            <p><strong>Op√©rateur:</strong> ${fiche.validation?.operatorName || '---'}</p>
            <p><strong>Phase:</strong> ${fiche.validation?.phase || fiche.phase || '---'}</p>
            <button class="btn btn-primary" onclick="modifierFiche('${id}')">‚úèÔ∏è Modifier</button>
            <button class="btn btn-submit" style="background-color:#e74c3c;" onclick="supprimerFiche('${id}')">üóëÔ∏è Supprimer</button>
          `;

          dashboardList.appendChild(ficheDiv);
        }
      });
    });
});

// ‚úÖ Export Excel
document.getElementById("btn-export").addEventListener("click", () => {
  showLoader(true);
  firebase.database().ref("fiches").once("value")
    .then(snapshot => {
      const fiches = snapshot.val();
      if (!fiches) {
        showLoader(false);ÿ≥ÿ≥
        alert("Aucune fiche √† exporter.");
        return;
      }

      const data = Object.values(fiches).map(fiche => ({
        Date: fiche.date || "Non renseign√©",
        Service: fiche.reception?.service || "Non renseign√©",
        Transport: fiche.reception?.transport || "Non renseign√©",
        "Obs. r√©ception": fiche.reception?.observations || "Non renseign√©",
        Produit: fiche.nettoyage?.product || "Non renseign√©",
        Temp√©rature: fiche.nettoyage?.temperature || "Non renseign√©",
        Rin√ßage: fiche.nettoyage?.rinse || "Non renseign√©",
        S√©chage: fiche.nettoyage?.drying || "Non renseign√©",
        Op√©rateur: fiche.validation?.operatorName || "Non renseign√©",
        Phase: fiche.validation?.phase || fiche.phase || "Non renseign√©",
        ResponsableStockage: fiche.stockage?.agentResponsable || "Non renseign√©",
        Logiciel: fiche.stockage?.logiciel || "Non renseign√©",
        Quantit√©Stock√©e: fiche.stockage?.quantite || "Non renseign√©",
        Distributeur: fiche.stockage?.agentDistribution || "Non renseign√©",
        DateDistribution: fiche.stockage?.dateDistribution || "Non renseign√©"

}));


      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Fiches");

      XLSX.writeFile(wb, "fiches_sterilisation.xlsx");
      showLoader(false);
    });
});

// ‚úÖ D√©connexion : Retour √† la page d'accueil
document.getElementById("btn-deconnexion").addEventListener("click", function () {
  localStorage.removeItem("utilisateurConnecte"); // ÿ≠ÿ∞ŸÅ ÿßŸÑÿ¨ŸÑÿ≥ÿ©
  document.getElementById("app-container").classList.add("hidden");
  document.getElementById("welcome-page").classList.remove("hidden");
});
// ‚úÖ Nouvelle fiche : r√©initialiser le formulaire
document.getElementById("btn-nouveau").addEventListener("click", () => {
  const confirmation = confirm("‚ö†Ô∏è Voulez-vous vraiment cr√©er une nouvelle fiche ?");
  if (!confirmation) return;

  localStorage.removeItem("ficheEnEdition");
  resetForm(); // üßπ ŸÖÿ≥ÿ≠ ÿßŸÑÿ≠ŸÇŸàŸÑ
  document.getElementById("btn-retour").click(); // ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÜŸÖŸàÿ∞ÿ¨

  showToast("üÜï Nouvelle fiche r√©initialis√©e !");
});



function genererStatistiques(fiches) {
  console.log("üìä D√©marrage du rendu des statistiques...");
  // ‚úÖ Calculer % des fiches sign√©es
let fichesSignees = 0;
const total = Object.keys(fiches).length;

Object.values(fiches).forEach(fiche => {
  if (
    fiche?.validation?.operatorSignature &&
    fiche?.validation?.supervisorSignature
  ) {
    fichesSignees++;
  }
});

const pourcentageSign√©es = total === 0
  ? 0
  : Math.round((fichesSignees / total) * 100);

// ‚¨áÔ∏è Cr√©er ou mettre √† jour l'affichage (tu peux cr√©er ce <p> dans le HTML)
let statPourcentage = document.getElementById("pourcentage-signature");
if (!statPourcentage) {
  statPourcentage = document.createElement("p");
  statPourcentage.id = "pourcentage-signature";
  document.getElementById("dashboard-charts").prepend(statPourcentage);
}
statPourcentage.textContent = pourcentageSign√©es + "% fiches sign√©es";
let fichesIncompletes = 0;

Object.values(fiches).forEach(fiche => {
  if (
    !fiche?.validation?.operatorSignature ||
    !fiche?.validation?.supervisorSignature
  ) {
    fichesIncompletes++;
  }
});

document.getElementById("fiches-incompletes").textContent =
  fichesIncompletes + " fiches incompl√®tes";
  let maintenant = Date.now();
let semaine = 0;
let mois = 0;

Object.values(fiches).forEach(fiche => {
  const dateFiche = new Date(fiche.date).getTime();
  if (maintenant - dateFiche <= 7 * 24 * 60 * 60 * 1000) {
    semaine++;
  }
  if (maintenant - dateFiche <= 30 * 24 * 60 * 60 * 1000) {
    mois++;
  }
});

document.getElementById("fiches-semaine").textContent =
  semaine + " cette semaine";

document.getElementById("fiches-mois").textContent =
  mois + " ce mois";


  const services = {};
  const phases = {};
  const transports = {};
  const produits = {};
  const operateurs = {};
  const logiciels = {};


  Object.values(fiches).forEach(fiche => {
    const service = fiche.reception?.service || 'Inconnu';
    const phase = fiche.validation?.phase || fiche.phase || 'Inconnue';
    const transport = fiche.reception?.transport || 'Inconnu';
    const produit = fiche.nettoyage?.product || 'Inconnu';
    const operateur = fiche.validation?.operatorName || 'Inconnu';
    const logiciel = fiche.stockage?.logiciel || 'Non renseign√©';
    logiciels[logiciel] = (logiciels[logiciel] || 0) + 1;


    services[service] = (services[service] || 0) + 1;
    phases[phase] = (phases[phase] || 0) + 1;
    transports[transport] = (transports[transport] || 0) + 1;
    produits[produit] = (produits[produit] || 0) + 1;
    operateurs[operateur] = (operateurs[operateur] || 0) + 1;
  });

  const chartConfigs = [
    { id: 'serviceChart', label: 'Fiches par service', data: services, type: 'bar' },
    { id: 'phaseChart', label: 'Fiches par phase', data: phases, type: 'pie' },
    { id: 'transportChart', label: 'Fiches par transport', data: transports, type: 'bar' },
    { id: 'produitChart', label: 'Produits utilis√©s', data: produits, type: 'doughnut' },
    { id: 'operateurChart', label: 'Fiches par op√©rateur', data: operateurs, type: 'bar' },
  ];

  chartConfigs.forEach(config => {
    const canvas = document.getElementById(config.id)?.getContext('2d');
    if (!canvas) return; // ÿ™ŸÅÿßÿØŸä ÿßŸÑÿÆÿ∑ÿ£ ÿ•ÿ∞ÿß ŸÖÿß ŸÉÿßŸÜÿ¥ ÿßŸÑÿπŸÜÿµÿ± ŸÖŸàÿ¨ŸàÿØ

    new Chart(canvas, {
      type: config.type,
      data: {
        labels: Object.keys(config.data),
        datasets: [{
          label: config.label,
          data: Object.values(config.data),
          backgroundColor: ['#3498db', '#2ecc71', '#e74c3c', '#9b59b6', '#f39c12', '#1abc9c']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: config.type !== 'bar' },
          title: { display: true, text: config.label }
        }
      }
    });
  });
  // ‚úÖ Dessiner le graphique des logiciels utilis√©s (Stockage)
const ctxLogiciel = document.createElement("canvas");
ctxLogiciel.id = "logicielChart";
ctxLogiciel.style.maxHeight = "300px";
ctxLogiciel.style.marginTop = "40px";
document.getElementById("dashboard-charts").appendChild(ctxLogiciel);

new Chart(ctxLogiciel, {
  type: 'bar',
  data: {
    labels: Object.keys(logiciels),
    datasets: [{
      label: "Logiciels utilis√©s (Stockage)",
      backgroundColor: "#9b59b6",
      data: Object.values(logiciels)
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { display: false },
      title: {
        display: true,
        text: 'R√©partition des logiciels de stockage'
      }
    }
  }
});

}




function clearSignature(role) {
  if (role === 'operator') operatorSignaturePad.clear();
  if (role === 'supervisor') supervisorSignaturePad.clear();
}
function resetForm() {
  // üóì ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
  document.getElementById('date').value = '';

  // ‚úÖ R√©ception
  document.getElementById('arrival-time').value = '';
  document.getElementById('service').value = '';
  document.getElementById('transport').value = '';
  document.getElementById('reception-observations').value = '';
  document.getElementById('risk-prion').checked = false;
  document.getElementById('risk-other').checked = false;
  document.querySelector('#risk-other').closest('.form-group').querySelector('input[type="text"]').value = '';
  document.querySelector('#risk-other').closest('.form-group').querySelector('input[type="text"]').style.display = 'none';
  document.getElementById('pretreatment-done').checked = true;

  // ‚úÖ Tri
  document.getElementById('protocol-manual').checked = false;
  document.getElementById('protocol-washer').checked = false;
  document.getElementById('protocol-ultrasound').checked = false;
  document.getElementById('quantity-complete').checked = true;
  document.getElementById('quality-ok').checked = true;
  document.getElementById('quality-damaged').checked = false;
  document.getElementById('quality-rusty').checked = false;
  document.getElementById('sorting-observations').value = '';

  // ‚úÖ Nettoyage
  document.getElementById('cleaning-product').value = '';
  document.getElementById('temp-35-45').checked = true;
  document.getElementById('temp-40-60').checked = false;
  document.getElementById('temp-50-60').checked = false;
  document.getElementById('rinse-yes').checked = true;
  document.getElementById('rinse-no').checked = false;
  document.getElementById('drying-auto').checked = true;
  document.getElementById('drying-manual').checked = false;
  document.getElementById('drying-no').checked = false;
  document.getElementById('cleaner-name').value = '';
  document.getElementById('cleaning-observations').value = '';

  // ‚úÖ Validation
  document.getElementById('operator-name').value = '';
  document.getElementById('supervisor-name').value = '';
  document.getElementById('phase').value = 'R√©ception';
  if (operatorSignaturePad) operatorSignaturePad.clear();
  if (supervisorSignaturePad) supervisorSignaturePad.clear();

  document.getElementById('date').value = new Date().toISOString().split('T')[0];

}
setInterval(() => {
  const draft = {
    date: document.getElementById('date')?.value,
    arrivalTime: document.getElementById('arrival-time')?.value,
    service: document.getElementById('service')?.value,
    transport: document.getElementById('transport')?.value,
    observations: document.getElementById('reception-observations')?.value
  };

  localStorage.setItem("draftFiche", JSON.stringify(draft));
  console.log("üì• Brouillon sauvegard√©");
}, 60000); // ŸÉŸÑ 60 ÿ´ÿßŸÜŸäÿ©

document.getElementById("btn-filtrer").addEventListener("click", () => {
  const dateFiltre = document.getElementById("filtre-date").value;  // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸÖŸÜ ÿßŸÑŸÖÿØÿÆŸÑ
  const serviceFiltre = document.getElementById("filtre-service").value;  // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿÆÿØŸÖÿ© ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©
  
  const dashboardList = document.getElementById("dashboard-list");
  dashboardList.innerHTML = '<p>Chargement...</p>'; // ÿ•ÿ∏Ÿáÿßÿ± ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
  showLoader(true);

  // ÿßÿ≥ÿ™ÿπŸÑÿßŸÖ Firebase ŸÖÿπ ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ŸàÿßŸÑÿÆÿØŸÖÿ©
  let query = firebase.database().ref('fiches').orderByChild('date');
  
  if (dateFiltre) {
    query = query.equalTo(dateFiltre);  // ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
  }

  if (serviceFiltre) {
    query = query.equalTo(serviceFiltre, 'reception/service');  // ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿÆÿØŸÖÿ©
  }

  query.once('value')
    .then(snapshot => {
      const fiches = snapshot.val();
      dashboardList.innerHTML = '';

      if (!fiches) {
        dashboardList.innerHTML = '<p>Aucune fiche trouv√©e.</p>';
        showLoader(false);  // ÿ•ÿÆŸÅÿßÿ° ŸÖÿ§ÿ¥ÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ÿπÿØ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°
        return;
      }

      Object.entries(fiches).forEach(([id, fiche]) => {
        const ficheDiv = document.createElement("div");
        ficheDiv.innerHTML = `
          <p><strong>Date:</strong> ${fiche.date || '---'}</p>
          <p><strong>Service:</strong> ${fiche.reception?.service || '---'}</p>
          <p><strong>Type de bo√Æte:</strong> ${fiche.reception?.boite || '---'}</p>
          <p><strong>Transport:</strong> ${fiche.reception?.transport || '---'}</p>
          <p><strong>Observation r√©ception:</strong> ${fiche.reception?.observations || '---'}</p>
        `;
        dashboardList.appendChild(ficheDiv);
      });
      showLoader(false);
    })
    .catch(error => {
      console.error('Erreur lors du chargement:', error);
      dashboardList.innerHTML = '<p style="color:red;">Erreur lors du chargement des fiches.</p>';
      showLoader(false);
    });
});


    </script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- üîÑ Loader d‚Äôattente -->
<div id="loader" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center;">
    <div style="border: 4px solid #ccc; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
  </div>
  <style>
  @keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
  }
  .desktop-menu { display: flex; gap: 10px; }
.mobile-menu { display: none; position: relative; }

@media (max-width: 768px) {
  .desktop-menu { display: none; }
  .mobile-menu { display: block; }
}

  </style>
  <script>
    function showLoader(show = true) {
      document.getElementById("loader").style.display = show ? "flex" : "none";
    }
  </script>
<!-- ü™ü Modal personnalis√© -->
<div id="custom-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); display: flex; justify-content: center; align-items: center; z-index: 9999;">
    <div style="background: white; padding: 20px; border-radius: 10px; max-width: 300px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
      <p id="modal-message" style="margin-bottom: 20px;"></p>
      <button onclick="closeModal()" style="background-color: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">Fermer</button>
    </div>
  </div>
  <script>
    function showModal(message) {
      document.getElementById("modal-message").textContent = message;
      document.getElementById("custom-modal").classList.remove("hidden");
    }
    function closeModal() {
      document.getElementById("custom-modal").classList.add("hidden");
    }
    function verifierTri() {
  const nonComplet = document.getElementById("quantity-incomplete").checked;
  const rouille = document.getElementById("quality-rusty").checked;
  const observationField = document.getElementById("sorting-observations");

  if (nonComplet || rouille) {
    observationField.setAttribute("required", "required");
    observationField.placeholder = "‚ö†Ô∏è Veuillez pr√©ciser pourquoi.";
    observationField.style.border = "2px solid red";
  } else {
    observationField.removeAttribute("required");
    observationField.placeholder = "";
    observationField.style.border = "";
  }
}

// ‚úÖ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ÿπŸÜÿØ ŸÉŸÑ ÿ™ÿ∫ŸäŸäÿ±
document.getElementById("quantity-incomplete").addEventListener("change", verifierTri);
document.getElementById("quality-rusty").addEventListener("change", verifierTri);

  </script>
  
  
  <script>
  // ‚úÖ Burger Menu Mobile
    document.getElementById("burger-btn").addEventListener("click", () => {
      document.getElementById("burger-dropdown").classList.toggle("hidden");
    });
    document.getElementById("burger-dashboard").addEventListener("click", () => {
      document.getElementById("btn-dashboard").click();
    });
    document.getElementById("burger-nouveau").addEventListener("click", () => {
      document.getElementById("btn-nouveau").click();
    });
    document.getElementById("burger-deconnexion").addEventListener("click", () => {
      document.getElementById("btn-deconnexion").click();
    });

    function showToast(message, duration = 3000) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.style.display = "block";

  setTimeout(() => {
    toast.style.display = "none";
  }, duration);
}
let ficheEstSauvegardee = false;

window.addEventListener("beforeunload", function (e) {
  if (!ficheEstSauvegardee) {
    e.preventDefault();
    e.returnValue = "";
  }
});
</script>
<!-- ‚úÖ Toast message -->
<div id="toast" style="display: none; position: fixed; bottom: 20px; right: 20px; background-color: #2ecc71; color: white; padding: 12px 20px; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-weight: 500; z-index: 9999;"></div>


<script>
  function exportToPDF() {
    const element = document.querySelector(".form-section.active"); // ÿßŸÑÿ¨ÿ≤ÿ° ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ ŸÅŸÇÿ∑
    html2canvas(element).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      pdf.save("fiche_sterilisation.pdf");
    });
  }
  </script>
  <script>
  document.getElementById('btn-retour')?.addEventListener('click', () => {
    document.getElementById('dashboard-section').style.display = 'none';

    const allSections = Array.from(document.querySelectorAll('.form-section')).filter(
      section => section.id !== "dashboard-section"
    );

    allSections.forEach((section, index) => {
      section.style.display = index === 0 ? 'block' : 'none';
      section.classList.toggle('active', index === 0);
    });

    currentSection = 0;
    updateSections();

    const steps = document.querySelectorAll('.step');
    steps.forEach((step, index) => {
      step.classList.toggle('active', index === 0);
      step.classList.remove('completed');
    });

    setTimeout(() => {
      const canvases = document.querySelectorAll('.signature-canvas');
      if (canvases.length >= 2) {
        operatorSignaturePad = new SignaturePad(canvases[0]);
        supervisorSignaturePad = new SignaturePad(canvases[1]);
      }
    }, 300);
  });
</script>
<script>
  document.getElementById('btn-dashboard').addEventListener('click', () => {
    const dashboard = document.getElementById('dashboard-section');
    dashboard.style.display = 'block';
    document.querySelectorAll('.form-section').forEach(section => section.style.display = 'none');

    const dashboardList = document.getElementById('dashboard-list');
    dashboardList.innerHTML = '<p>Chargement...</p>';

    // ‚úÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase
    firebase.database().ref('fiches').limitToLast(20).once('value')
      .then(snapshot => {
        const fiches = snapshot.val();
        dashboardList.innerHTML = '';

        if (!fiches) {
          dashboardList.innerHTML = '<p>Aucune fiche trouv√©e.</p>';
          return;
        }

        if (fiches) genererStatistiques(fiches); // ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™

        Object.entries(fiches).forEach(([id, fiche]) => {
          const ficheDiv = document.createElement("div");
          ficheDiv.style.border = '1px solid #ccc';
          ficheDiv.style.padding = '10px';
          ficheDiv.style.marginBottom = '10px';
          ficheDiv.style.borderRadius = '6px';
          ficheDiv.style.backgroundColor = '#f9f9f9';

          ficheDiv.innerHTML = `
            <p><strong>Date:</strong> ${fiche.date || '---'}</p>
            <p><strong>Service:</strong> ${fiche.reception?.service || '---'}</p>
            <p><strong>Transport:</strong> ${fiche.reception?.transport || '---'}</p>
            <p><strong>Observation r√©ception:</strong> ${fiche.reception?.observations || '---'}</p>
            <p><strong>Produit nettoyage:</strong> ${fiche.nettoyage?.product || '---'}</p>
            <p><strong>Op√©rateur:</strong> ${fiche.validation?.operatorName || '---'}</p>
            <p><strong>Phase:</strong> ${fiche.validation?.phase || fiche.phase || '---'}</p>
            ${fiche.photoUrl ? `<img src="${fiche.photoUrl}" style="max-width: 100px;">` : ''}
            <button class="btn btn-primary" onclick="modifierFiche('${id}')">‚úèÔ∏è Modifier</button>
            <button class="btn btn-submit" style="background-color:#e74c3c;" onclick="supprimerFiche('${id}')">üóëÔ∏è Supprimer</button>
          `;
          dashboardList.appendChild(ficheDiv);
        });
      })
      .catch(error => {
        dashboardList.innerHTML = '<p style="color:red;">Erreur lors du chargement des fiches.</p>';
        console.error(error);
      });
  });
  

</script>
<script>
  function exportToExcel() {
    firebase.database().ref("fiches").once("value").then(snapshot => {
      const fiches = snapshot.val();
      if (!fiches) {
        alert("Aucune fiche √† exporter.");
        return;
      }

      const data = Object.values(fiches).map(fiche => ({
        Date: fiche.date || "Non renseign√©",
        Service: fiche.reception?.service || "Non renseign√©",
        "Type de bo√Æte": fiche.reception?.boite || "Non renseign√©",
        Transport: fiche.reception?.transport || "Non renseign√©",
        "Obs. r√©ception": fiche.reception?.observations || "Non renseign√©",
        Produit: fiche.nettoyage?.product || "Non renseign√©",
        Temp√©rature: fiche.nettoyage?.temperature || "Non renseign√©",
        Rin√ßage: fiche.nettoyage?.rinse || "Non renseign√©",
        S√©chage: fiche.nettoyage?.drying || "Non renseign√©",
        Op√©rateur: fiche.validation?.operatorName || "Non renseign√©",
        Phase: fiche.validation?.phase || fiche.phase || "Non renseign√©",
        ResponsableStockage: fiche.stockage?.agentResponsable || "Non renseign√©",
        Logiciel: fiche.stockage?.logiciel || "Non renseign√©",
        Quantit√©Stock√©e: fiche.stockage?.quantite || "Non renseign√©",
        Distributeur: fiche.stockage?.agentDistribution || "Non renseign√©",
        DateDistribution: fiche.stockage?.dateDistribution || "Non renseign√©"
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Fiches");

      XLSX.writeFile(wb, "fiches_sterilisation.xlsx");
    });
  }

  // ‚úÖ ÿ±ÿ®ÿ∑ ÿßŸÑÿ≤ÿ± ÿ®ÿßŸÑÿØÿßŸÑÿ©
  document.getElementById("btn-export")?.addEventListener("click", exportToExcel);
</script>


</body>
</html>
